<?php /** @noinspection ALL */

/** @noinspection SqlNoDataSourceInspection */

namespace App\Helpers\DB;

use DB;

class ExtendedSchema
{
    /*
     * When adding a column to a table with a default value constraint
     * the name of the constraint is randomly generated (e.g. DF__foo__bar__322242A7).
     * The problem occurs now in the rollback method
     * because it is not possible to drop the column
     * as long as the default constraint exists
     * and it is not possible to drop the constraint
     * because its name is randomly generated by the sql server.
     *
     * Workaround: https://github.com/laravel/framework/issues/4402
     */
    public static function dropDefaultMsSqlConstraint($tableName, $columnName)
    {
        if ('sqlsrv' == DB::connection()->getDriverName()) {
            /** @noinspection SqlResolve */
            $defaultConstraint = DB::selectOne(
                "SELECT OBJECT_NAME([default_object_id]) AS name 
                FROM SYS.COLUMNS 
                WHERE [object_id] = OBJECT_ID('[dbo].[$tableName]') AND [name] = '" . $columnName . "'
                ");
            /** @noinspection SqlResolve */
            DB::statement("ALTER TABLE [dbo].[$tableName] DROP CONSTRAINT $defaultConstraint->name");
        }
    }
}